name: Assign Last Merged Author

on:
  pull_request:
    types: [opened, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  assign-reviewer:
    runs-on: ubuntu-latest
    steps:
      - name: Find last merger and assign
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Contexto do PR atual
            const currentPr = context.payload.pull_request;
            const currentAuthor = currentPr.user.login;
            const baseBranch = currentPr.base.ref; // Branch alvo (ex: main)
            
            console.log(`Current PR #${currentPr.number} by ${currentAuthor} targeting ${baseBranch}`);

            // 1. Buscar PRs fechados recentemente na mesma base branch
            // Ordenados por atualização (o merge é uma atualização)
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              base: baseBranch,
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });

            // 2. Filtrar para pegar o primeiro que foi de fato MERGEADO
            // (Ignora PRs fechados sem merge)
            const lastMergedPr = pulls.find(pr => pr.merged_at !== null);

            if (!lastMergedPr) {
              console.log("Nenhum PR mergeado anteriormente encontrado nesta branch.");
              return;
            }

            const lastAuthor = lastMergedPr.user.login;
            console.log(`Último PR mergeado: #${lastMergedPr.number} por ${lastAuthor}`);

            // 3. Validação de Regras
            // Regra A: Se o autor for o mesmo, não faz nada (evita auto-review)
            if (lastAuthor === currentAuthor) {
              console.log("O autor do último PR é o mesmo do atual. Nenhuma ação necessária.");
              return;
            }

            // Regra B: Verificar se o usuário já não está como reviewer
            // (Para evitar erros de API duplicada, embora a API do GitHub trate isso bem)
            // Vamos direto para a tentativa de adição.
            
            // 4. Adicionar o Reviewer
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: currentPr.number,
                reviewers: [lastAuthor]
              });
              console.log(`Sucesso: ${lastAuthor} foi adicionado como reviewer.`);
            } catch (error) {
              console.error("Erro ao adicionar reviewer:", error.message);
              // Ocasionalmente pode falhar se o user não for colaborador, 
              // mas em ambiente corporativo isso é raro.
            }
